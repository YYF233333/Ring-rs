# Visual Novel Engine 开发路线图

> 本文档定义了项目的具体执行计划，遵循 PLAN.md 中的架构约束。

---

## 项目当前状态

### ✅ 已完成模块

1. **vn-runtime 核心运行时**
   - ✅ 脚本解析器（Parser）：支持完整语法规范，50+ 测试用例
   - ✅ AST 定义：完整的脚本节点类型
   - ✅ Command 定义：Runtime → Host 通信协议
   - ✅ RuntimeInput 定义：Host → Runtime 输入模型
   - ✅ WaitingReason 定义：显式等待状态模型
   - ✅ RuntimeState 定义：可序列化的运行时状态
   - ✅ Engine（VNRuntime）：核心执行引擎
   - ✅ Executor：AST 节点到 Command 的转换
   - ✅ 错误处理：完整的错误类型和错误信息

2. **host 适配层（macroquad）**
   - ✅ 窗口与主循环
   - ✅ 资源管理系统
   - ✅ 渲染系统（基础）
   - ✅ 输入处理
   - ✅ Command 执行器
   - ✅ Runtime 集成
   - ✅ 过渡效果实现
   - ✅ 音频系统

---

## 阶段 1-9 完成汇总

### ✅ 主要完成内容

1. **阶段 1-2：基础框架 + 资源管理**
   - 窗口/主循环/调试信息
   - `ResourceManager` 负责图片与音频资源加载、缓存与路径解析

2. **阶段 3：渲染系统（基础）**
   - 背景、角色、对话框、选择分支 UI 基础渲染
   - 中文字体加载与打字机效果

3. **阶段 4：输入处理**
   - `InputManager` 统一采集鼠标/键盘输入
   - WaitingReason 驱动的输入分发与防抖

4. **阶段 5：Command 执行器**
   - 完整 Command 分发与 RenderState 更新
   - 过渡效果与音频命令的执行管线

5. **阶段 6：Runtime 集成**
   - Script 模式接入 `VNRuntime` 与 `Parser`
   - Demo/Command/Script 三模式切换

6. **阶段 7：过渡效果**
   - dissolve/fade/fadewhite 过渡支持
   - 背景切换时自动应用过渡

7. **阶段 8：音频系统**
   - `AudioManager` 采用 `rodio`，支持 MP3/WAV/FLAC/OGG
   - BGM 循环/淡入淡出/切换，SFX 播放与音量控制

8. **阶段 9：UI 完善**
   - 选择分支支持鼠标悬停高亮与点击选择
   - 章节标题移至左上角，避免遮挡内容

### 🚧 未完成部分（当前遗留）

- **阶段 7**：`rule` 遮罩过渡（未实现）
- **阶段 9**：对话框样式增强（阴影/描边/样式优化未实现）
- **阶段 10**：全面测试与优化（未开始）

### ▶️ 下一阶段开发计划（阶段 10）

1. **功能测试**
   - 使用完整脚本进行端到端验证
   - 覆盖所有 Command / 过渡效果 / 选择分支

2. **性能优化**
   - 资源加载优化（预加载与回收）
   - 渲染性能与内存占用优化

3. **错误处理与稳定性**
   - 资源加载失败降级策略
   - 脚本解析错误提示与恢复机制

4. **文档完善**
   - Host 使用文档与 API 说明
   - README 更新与示例补充

---

### 阶段 10：测试与优化（Testing & Optimization）

**目标**：全面测试系统，修复 bug，优化性能。

**任务清单**：

1. **功能测试**
   - [ ] 使用完整脚本进行端到端测试
   - [ ] 测试所有 Command 类型
   - [ ] 测试所有过渡效果
   - [ ] 测试选择分支和跳转

2. **性能优化**
   - [ ] 优化资源加载（预加载、异步加载）
   - [ ] 优化渲染性能（减少 draw call）
   - [ ] 优化内存使用（资源释放）

3. **错误处理完善**
   - [ ] 添加资源加载失败的降级处理
   - [ ] 添加脚本解析错误的友好提示
   - [ ] 实现错误恢复机制

4. **文档完善**
   - [ ] 编写 Host 层的使用文档
   - [ ] 添加代码注释
   - [ ] 更新 README

**验收标准**：
- 所有功能正常工作
- 性能稳定（60 FPS）
- 错误处理完善
- 文档完整

**预计工作量**：3-4 天

---

## 开发原则

1. **遵循 PLAN.md 约束**
   - Runtime 与 Host 严格分离
   - Command 驱动模式
   - 显式状态管理

2. **测试驱动开发**
   - 每个模块都要有单元测试
   - 关键功能要有集成测试
   - 修复 bug 后补充回归测试

3. **渐进式开发**
   - 先实现核心功能，再完善细节
   - 每个阶段都要有可运行的版本
   - 及时集成和测试

4. **代码质量**
   - 清晰的模块划分
   - 完善的文档注释
   - 遵循 Rust 最佳实践

---

> **注意**：本路线图是动态文档，会根据实际开发进度和需求变化进行调整。
